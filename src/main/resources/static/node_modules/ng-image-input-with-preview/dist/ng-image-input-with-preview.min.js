/*! ng-image-input-with-preview v1.0.0 */

!function(e,i){"use strict";e.module("fileReaderService",[]).factory("fileReader",["$q",function(f){return{readAsDataUrl:function(e,i){var n,r,t,a,o,s,c,d,l,u=f.defer();return(n=u,r=i,(l=new FileReader).onload=(t=l,a=n,o=r,function(){o.$apply(function(){a.resolve(t.result)})}),l.onerror=(s=l,c=n,d=r,function(){d.$apply(function(){c.reject(s.result)})}),l).readAsDataURL(e),u.promise}}}]),e.module("ngImageInputWithPreview",["fileReaderService"]).directive("imageWithPreview",["fileReader","$q",function(o,s){var c="this-is-not-an-image",d=function(){var e=s.defer();return e.resolve(),e.promise};return{restrict:"A",require:"ngModel",scope:{image:"=ngModel",allowedTypes:"@accept",dimensionRestrictions:"&dimensions",sizeRestrictions:"&size"},link:function(t,e,a,n){e.bind("change",function(e){var i=(e.srcElement||e.target).files[0];n.$setViewValue(i,"change")}),n.$parsers.push(function(e){return e?(i=t.allowedTypes,r=e,i||(i="image/png,image/jpeg"),i.split(",").some(function(e){if(e===r.type)return!0;var i=e.split("/"),n=r.type.split("/");return 2===i.length&&2===n.length&&"*"===i[1]&&i[0]===n[0]})?{fileReaderPromise:o.readAsDataUrl(e,t)}:c):e;var i,r}),t.$watch("image",function(e){e&&"string"==typeof e&&(t.image={src:e,isPath:!0})}),n.$validators.image=function(e,i){return(e||i)!==c},n.$asyncValidators.parsing=function(e,i){var n=e||i;return n&&n.fileReaderPromise?(n.fileReaderPromise.finally(function(){delete n.fileReaderPromise}),n.fileReaderPromise.then(function(e){n.src=e},function(){return s.reject("Failed to parse")})):d()},n.$asyncValidators.dimensions=function(e,i){if(!a.dimensions)return d();var n=e||i;if(!n||!n.fileReaderPromise)return d();var r=s.defer();return n.fileReaderPromise.then(function(e){var i=document.createElement("img");i.addEventListener("load",function(){var e=t.dimensionRestrictions({width:i.width,height:i.height});t.$apply(function(){e?r.resolve():r.reject("Invalid dimensions")})}),i.addEventListener("error",function(){t.$apply(function(){r.reject("Failed to detect dimensions. Not an image!")})}),i.src=e},function(){r.reject("Failed to detect dimensions")}),r.promise},n.$asyncValidators.size=function(e,n){if(!a.size)return d();var i=e||n;if(!i||!i.fileReaderPromise)return d();var r=s.defer();return i.fileReaderPromise.then(function(e){var i=document.createElement("img");i.addEventListener("load",function(){var e=t.sizeRestrictions({size:n.size});t.$apply(function(){e?r.resolve():r.reject("Invalid size")})}),i.src=e},function(){r.reject("Failed to detect size")}),r.promise}}}}])}(window.angular);